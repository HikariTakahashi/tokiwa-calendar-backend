昨日は労働した。POP(値段と商品名とかが書いてるやつ)の期限が本日までなのでひっぺがす仕事をした。無心で POP をひっぺがしていると、数週間前に貼っつけた POP を剥がしていることに気づき、賽の河原で鬼にブチギレられながら石を詰むガキ、もしくは穴を掘っては埋め続ける拷問を受ける囚人の心を理解した。
ちなみに、Auth.js の導入を検討した。Auth.js はログイン・サインアップの処理を代わりにやってくれる神ライブラリで**バックエンドのファイル 5 ファイルぐらいと 7 月の 2 週間ぐらいの努力を消し飛ばす代物**だが、その場合ログイン・サインアップ時の**DB(Firebase Authentication)のデータ格納をフロントエンドにて処理**することになり、**従来の「フロント → バック →DB」の設計思想を破壊することになるため、導入をやめた**。あとこれ、7 月初めにゆせさんにおすすめされたライブラリなので朝会で聞かれたらこう答えてほしい。

【今日の実装】
目次
1. メール送信機能の実装
2. Google Auth を使用したログイン・サインアップの実装
3. Git Hub Auth を使用したログイン・サインアップの実装

## メール送信機能の実装

### `email_utils.go`

**役割**: メール認証システムの基盤となるメール送信機能を提供

**機能**:

- **認証トークン生成**: 32 バイトのランダムトークン生成と 24 時間の有効期限設定
- **SMTP 設定管理**: SMTP(インターネット上で E メールメッセージを送受信するために使用される通信プロトコル)設定を環境変数から取得
- **メール送信処理**: STARTTLS 接続(メール送信時に、メールソフトとメールサーバー間、またはメールサーバー間の通信を暗号化する技術)によるセキュアなメール送信
- **設定検証**: メール設定の妥当性を事前にチェック

**特徴**: メール認証システムの「心臓部」として、トークン生成からメール送信まで一貫して処理

### `firestore_save.go`

**役割**: Firestore データベースへのデータ保存を担当

**機能**:

- スケジュール保存: 既存のスケジュールデータ保存機能
- **認証トークン保存**: 新規追加された認証トークンの Firestore 保存
- **コレクション管理**: 認証トークン専用コレクション（`_verification_tokens`）の管理

**特徴**: データの永続化を担当し、認証トークンの安全な保管を実現

### `firestore_get.go`

**役割**: Firestore からのデータ取得と認証トークンの検証を担当

**機能**:

- スケジュール取得: 既存のスケジュールデータ取得機能
- **認証トークン取得**: 保存されたトークンの取得
- **メール認証処理**: トークンの検証と Firebase Authentication での認証状態更新
- **期限切れ処理**: 期限切れトークンの自動削除と未認証ユーザーの削除

**特徴**: 認証システムの「検証エンジン」として、トークンの有効性を判定し適切な処理を実行

### `firestore_cleanup.go`

**役割**: 期限切れデータの自動削除とシステムの健全性維持

**機能**:

- **期限切れトークン削除**: 有効期限を過ぎた認証トークンの削除
- **未認証ユーザー削除**: 24 時間以上認証されていないユーザーの削除
- **重複処理防止**: 同じユーザーの重複削除を防ぐ仕組み
- **ログ記録**: 削除処理の詳細なログ出力

**特徴**: システムの「掃除係」として、不要なデータを自動的に整理し、データベースの健全性を維持

### **`handler_signup.go`**

**役割**: 新規ユーザーの登録と認証メール送信の統合処理

**機能**:

- ユーザー登録: Firebase Authentication でのユーザー作成
- パスワード処理: 暗号化されたパスワードの復号化と強度チェック
- **認証フロー統合**: トークン生成 → 保存 → メール送信の一連の流れ
- **エラーハンドリング**: 各段階でのエラー処理と適切なレスポンス

**特徴**: ユーザー登録の「窓口」として、複数の処理を統合的に管理

### **`handler_verify.go`**

**役割**: メール認証トークンの検証とユーザー認証状態の更新

**機能**:

- **トークン検証**: フロントエンドから送信されたトークンの検証
- **認証状態管理**: 既に認証済みかどうかの判定
- **レスポンス生成**: 認証結果に応じた適切なレスポンス
- **エラー処理**: 無効なトークンや期限切れトークンへの対応

**特徴**: 認証システムの「検証窓口」として、フロントエンドとバックエンドの認証処理を橋渡し

### **`handler_get.go`**

**役割**: 設定確認とスケジュールデータ取得の統合処理

**機能**:

- スケジュール取得: 既存のスケジュールデータ取得機能
- **メール設定確認**: `/email-config`エンドポイントでの設定状況確認
- **設定検証**: メール設定の妥当性チェックと結果表示

**特徴**: システムの「診断機能」として、設定状況の確認とデータ取得を統合

### **`handler_post.go`**

**役割**: スケジュールデータの投稿と保存

**機能**:

- スケジュール投稿: フロントエンドからのスケジュールデータ受信
- データ変換: JSON データの構造体への変換とデフォルト値設定
- **ユーザー関連付け**: ログインユーザーの UID とスケジュールの関連付け
- **Firestore 保存**: 処理済みデータの Firestore への保存

**特徴**: データ投稿の「受付窓口」として、フロントエンドからのデータを適切に処理

### **`main_scheduler.go`**

**役割**: CloudWatch Events による定期クリーンアップの実行

**機能**:

- **スケジューラー**: 定期実行の Lambda ハンドラー
- **クリーンアップ実行**: 期限切れデータの自動削除
- **ログ記録**: 定期実行の結果ログ

**特徴**: システムの「自動メンテナンス」として、定期的なデータクリーンアップを実行

### **`test_cleanup.go`**

**役割**: ローカル開発環境でのクリーンアップ機能テスト

**機能**:

- **テスト実行**: クリーンアップ機能の手動テスト
- **遅延実行**: 指定時間後のクリーンアップテスト
- **開発支援**: ローカル環境での機能検証

**特徴**: 開発環境での「テストツール」として、クリーンアップ機能の検証を支援

## Google 　 Auth を使用したログイン・サインアップの実装

## Git Hub Auth を使用したログイン・サインアップの実装

### `handler_google_auth.go`

**役割**: Google アカウントを使用した SSO 認証の完全実装

**機能**:

- **OAuth2.0 認証フロー**: 認証コードの交換とアクセストークン取得
- **Google API 統合**: Google User Info API からのユーザー情報取得
- **Firebase 統合**: Google アカウントでの Firebase ユーザー作成・取得
- **アカウント連携**: 既存メールユーザーとの自動連携

**特徴**: Google の公式 OAuth2.0 プロトコルに準拠した安全な認証システム

### `handler_github_auth.go`

**役割**: GitHub アカウントを使用した SSO 認証の完全実装

**機能**:

- **GitHub OAuth2.0**: GitHub 固有の OAuth2.0 実装
- **メール取得**: GitHub API からのメールアドレス取得（複数メール対応）
- **プロフィール連携**: GitHub プロフィール情報の自動同期
- **アカウント統合**: 既存ユーザーとの自動アカウント連携

**特徴**: GitHub の API 仕様に特化した認証システム

### `main.go`

**追加機能**:

- **Google 認証ハンドラー**: `handleGoogleAuthRequest()` の追加
- **GitHub 認証ハンドラー**: `handleGitHubAuthRequest()` の追加
- **SSO ルーティング**: `/api/auth/google` と `/api/auth/github` エンドポイント

**変更点**: 既存の API ルーターに SSO 認証エンドポイントを統合

### `main_lambda.go`

**追加機能**:

- **SSO 認証処理**: Google・GitHub 認証の Lambda 対応
- **OAuth2.0 統合**: クラウド環境での OAuth2.0 認証フロー
- **エラーハンドリング**: SSO 認証特有のエラー処理

**変更点**: 既存の Lambda ハンドラーに SSO 認証ロジックを統合
